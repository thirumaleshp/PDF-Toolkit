<!DOCTYPE html>
<html lang="en" class="dark">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>All-in-One File Converter</title>
    
    <!-- PWA Manifest -->
    <link rel="manifest" href="manifest.json">
    <meta name="theme-color" content="#4f46e5">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="apple-mobile-web-app-title" content="File Converter">
    
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700;800&display=swap');
        body {
            font-family: 'Inter', sans-serif;
        }
        .hidden { display: none; }
        .prose table { border-collapse: collapse; width: 100%; }
        .prose th, .prose td { border: 1px solid #dddddd; text-align: left; padding: 8px; }
        .prose th { background-color: #f2f2f2; }
    </style>
</head>
<body class="bg-gray-50 dark:bg-gray-900 text-gray-900 dark:text-gray-100">

    <!-- Library Scripts - Loaded Dynamically for Performance -->
    <script>
        // Library cache for dynamic loading
        window.libraryCache = {};
        
        // Dynamic library loader
        async function loadLibrary(name, url) {
            if (window.libraryCache[name]) return window.libraryCache[name];
            
            return new Promise((resolve, reject) => {
                const script = document.createElement('script');
                script.src = url;
                script.onload = () => {
                    window.libraryCache[name] = true;
                    resolve();
                };
                script.onerror = reject;
                document.head.appendChild(script);
            });
        }
        
        // Core libraries (always loaded)
        const coreLibraries = [
            ['jspdf', 'https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js'],
            ['pdf-lib', 'https://cdnjs.cloudflare.com/ajax/libs/pdf-lib/1.17.1/pdf-lib.min.js']
        ];
        
        // Optional libraries (loaded on demand)
        const optionalLibraries = {
            heic2any: 'https://cdnjs.cloudflare.com/ajax/libs/heic2any/0.0.4/heic2any.min.js',
            mammoth: 'https://cdnjs.cloudflare.com/ajax/libs/mammoth/1.7.2/mammoth.browser.min.js',
            xlsx: 'https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js',
            html2canvas: 'https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js',
            jszip: 'https://cdnjs.cloudflare.com/ajax/libs/jszip/3.10.1/jszip.min.js',
            qrcode: 'https://cdnjs.cloudflare.com/ajax/libs/qrcode/1.5.3/qrcode.min.js',
            qrscanner: 'https://cdnjs.cloudflare.com/ajax/libs/qr-scanner/1.4.2/qr-scanner.umd.min.js'
        };
        
        // Load core libraries immediately
        Promise.all(coreLibraries.map(([name, url]) => loadLibrary(name, url)))
            .then(() => console.log('Core libraries loaded'))
            .catch(err => console.error('Failed to load core libraries:', err));
    </script>

    <main class="container mx-auto p-4 sm:p-6 lg:p-8">
        <!-- Home Screen -->
        <div id="home-screen">
            <div class="text-center mb-12">
                <h1 class="text-4xl sm:text-5xl lg:text-6xl font-extrabold text-gray-800 dark:text-white">
                    All-in-One File Converter
                </h1>
                <p class="mt-4 max-w-2xl mx-auto text-lg text-gray-500 dark:text-gray-400">
                    Your free, private, and powerful toolkit for converting files. All conversions happen locally in your browser - no uploads required!
                </p>
            </div>
            <div id="tool-grid" class="grid grid-cols-2 md:grid-cols-3 lg:grid-cols-4 gap-4 md:gap-8">
                <!-- Tool cards will be injected here by JavaScript -->
            </div>
        </div>

        <!-- Conversion Interface -->
        <div id="conversion-screen" class="hidden">
            <div class="w-full max-w-3xl mx-auto">
                <button id="back-button" class="flex items-center gap-2 mb-6 text-indigo-600 dark:text-indigo-400 font-semibold hover:underline">
                    <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><line x1="19" y1="12" x2="5" y2="12"></line><polyline points="12 19 5 12 12 5"></polyline></svg>
                    Back to Tools
                </button>
                <div class="bg-white dark:bg-gray-800/50 p-8 rounded-2xl shadow-xl border border-gray-200 dark:border-gray-700">
                    <div id="conversion-header" class="flex items-center gap-4 mb-6">
                        <!-- Header will be injected here -->
                    </div>

                    <div class="space-y-6">
                        <!-- Output Format Selector -->
                        <div id="output-format-container" class="hidden">
                            <label for="output-format-select" class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-1">Convert to:</label>
                            <select id="output-format-select" class="mt-1 block w-full pl-3 pr-10 py-2 text-base border-gray-300 dark:border-gray-600 bg-white dark:bg-gray-700 text-gray-900 dark:text-white focus:outline-none focus:ring-indigo-500 focus:border-indigo-500 sm:text-sm rounded-md shadow-sm">
                                <!-- Options will be injected here -->
                            </select>
                        </div>

                        <!-- Page Range Input for PDF Split -->
                        <div id="page-range-container" class="hidden">
                            <label for="page-ranges" class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-1">Page Ranges (e.g., 1-3,5,7-10):</label>
                            <input type="text" id="page-ranges" class="mt-1 block w-full pl-3 pr-3 py-2 text-base border-gray-300 dark:border-gray-600 bg-white dark:bg-gray-700 text-gray-900 dark:text-white focus:outline-none focus:ring-indigo-500 focus:border-indigo-500 sm:text-sm rounded-md shadow-sm" placeholder="1-3,5,7-10">
                        </div>

                        <!-- Export Format Selector -->
                        <div id="export-format-container" class="hidden">
                            <label for="export-format-select" class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-1">Export to:</label>
                            <select id="export-format-select" class="mt-1 block w-full pl-3 pr-10 py-2 text-base border-gray-300 dark:border-gray-600 bg-white dark:bg-gray-700 text-gray-900 dark:text-white focus:outline-none focus:ring-indigo-500 focus:border-indigo-500 sm:text-sm rounded-md shadow-sm">
                                <option value="word">Word (.docx)</option>
                                <option value="excel">Excel (.xlsx)</option>
                                <option value="powerpoint">PowerPoint (.pptx)</option>
                                <option value="images">Images (.png)</option>
                            </select>
                        </div>

                        <!-- Image Resize Controls -->
                        <div id="resize-controls" class="hidden space-y-4">
                            <div>
                                <label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-1">Resize Method:</label>
                                <select id="resize-method" class="mt-1 block w-full pl-3 pr-10 py-2 text-base border-gray-300 dark:border-gray-600 bg-white dark:bg-gray-700 text-gray-900 dark:text-white focus:outline-none focus:ring-indigo-500 focus:border-indigo-500 sm:text-sm rounded-md shadow-sm">
                                    <option value="dimensions">Custom Dimensions</option>
                                    <option value="percentage">Percentage Scale</option>
                                    <option value="preset">Preset Sizes</option>
                                </select>
                            </div>
                            <div id="dimension-inputs" class="grid grid-cols-2 gap-4">
                                <div>
                                    <label for="resize-width" class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-1">Width (px):</label>
                                    <input type="number" id="resize-width" class="mt-1 block w-full pl-3 pr-3 py-2 text-base border-gray-300 dark:border-gray-600 bg-white dark:bg-gray-700 text-gray-900 dark:text-white focus:outline-none focus:ring-indigo-500 focus:border-indigo-500 sm:text-sm rounded-md shadow-sm" placeholder="800">
                                </div>
                                <div>
                                    <label for="resize-height" class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-1">Height (px):</label>
                                    <input type="number" id="resize-height" class="mt-1 block w-full pl-3 pr-3 py-2 text-base border-gray-300 dark:border-gray-600 bg-white dark:bg-gray-700 text-gray-900 dark:text-white focus:outline-none focus:ring-indigo-500 focus:border-indigo-500 sm:text-sm rounded-md shadow-sm" placeholder="600">
                                </div>
                            </div>
                            <div>
                                <label class="flex items-center">
                                    <input type="checkbox" id="maintain-aspect-ratio" checked class="rounded border-gray-300 text-indigo-600 shadow-sm focus:border-indigo-300 focus:ring focus:ring-indigo-200 focus:ring-opacity-50">
                                    <span class="ml-2 text-sm text-gray-700 dark:text-gray-300">Maintain aspect ratio</span>
                                </label>
                            </div>
                        </div>

                        <!-- QR Code Text Input -->
                        <div id="qr-text-container" class="hidden">
                            <div class="mb-4">
                                <div class="flex gap-2 mb-3">
                                    <button id="qr-generate-tab" class="flex-1 py-2 px-4 bg-indigo-600 text-white rounded-lg font-medium">Generate QR</button>
                                    <button id="qr-scan-tab" class="flex-1 py-2 px-4 bg-gray-200 dark:bg-gray-700 text-gray-700 dark:text-gray-300 rounded-lg font-medium">Scan QR</button>
                                </div>
                            </div>
                            
                            <!-- Generate QR Section -->
                            <div id="qr-generate-section">
                                <label for="qr-text" class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-1">Text or URL for QR Code:</label>
                                <textarea id="qr-text" rows="3" class="mt-1 block w-full pl-3 pr-3 py-2 text-base border-gray-300 dark:border-gray-600 bg-white dark:bg-gray-700 text-gray-900 dark:text-white focus:outline-none focus:ring-indigo-500 focus:border-indigo-500 sm:text-sm rounded-md shadow-sm" placeholder="Enter text, URL, or any data to generate QR code"></textarea>
                            </div>
                            
                            <!-- Scan QR Section -->
                            <div id="qr-scan-section" class="hidden">
                                <label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-1">Upload QR Code Image:</label>
                                <p class="text-sm text-gray-500 dark:text-gray-400 mb-3">Upload an image containing a QR code to read its content</p>
                                <div id="qr-scan-result" class="hidden mt-4 p-4 bg-green-100 dark:bg-green-900/50 border border-green-300 dark:border-green-700 rounded-lg">
                                    <h4 class="font-semibold text-green-800 dark:text-green-200 mb-2">QR Code Content:</h4>
                                    <div id="qr-scan-content" class="text-green-700 dark:text-green-300 break-all"></div>
                                </div>
                            </div>
                        </div>

                        <!-- File Input -->
                        <div id="file-upload-container" class="relative border-2 border-dashed border-gray-300 dark:border-gray-600 rounded-lg p-6 text-center">
                            <svg class="mx-auto h-12 w-12 text-gray-400" xmlns="http://www.w3.org/2000/svg" width="48" height="48" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"></path><polyline points="17 8 12 3 7 8"></polyline><line x1="12" y1="3" x2="12" y2="15"></line></svg>
                            <label for="file-upload" class="relative cursor-pointer mt-4 font-semibold text-indigo-600 dark:text-indigo-400 hover:text-indigo-500">
                                <span id="file-upload-text">Upload a file</span>
                                <input id="file-upload" name="file-upload" type="file" class="sr-only" multiple>
                            </label>
                            <p id="file-name-display" class="mt-1 text-sm text-gray-500 dark:text-gray-400">
                                Drag and drop or click to upload
                            </p>
                        </div>

                        <!-- Convert Button -->
                        <button id="convert-button" class="hidden w-full flex items-center justify-center gap-3 bg-indigo-600 text-white font-bold py-4 px-6 rounded-lg shadow-md hover:bg-indigo-700 disabled:bg-indigo-400 disabled:cursor-not-allowed transition-all duration-300 text-lg">
                            <!-- Button content will be injected here -->
                        </button>

                        <!-- Status/Result Area -->
                        <div id="status-area"></div>
                    </div>
                </div>
            </div>
        </div>
    </main>

    <footer class="text-center mt-16 mb-8 text-gray-500 dark:text-gray-400 text-sm">
        <p>&copy; 2024 All-in-One File Converter. All conversions are done locally in your browser for complete privacy.</p>
    </footer>

    <script>
        document.addEventListener('DOMContentLoaded', () => {
            // --- SIMPLE PWA SUPPORT ---
            // Let the browser handle install prompts natively
            window.addEventListener('beforeinstallprompt', (e) => {
                // Don't prevent the default - let browser show native prompt
                console.log('PWA install prompt available');
            });

            // --- ERROR HANDLING ---
            window.addEventListener('error', (e) => {
                console.error('Application error:', e);
            });

            window.addEventListener('unhandledrejection', (e) => {
                console.error('Unhandled promise rejection:', e);
            });

            // --- SERVICE WORKER REGISTRATION ---
            if ('serviceWorker' in navigator) {
                window.addEventListener('load', () => {
                    navigator.serviceWorker.register('./sw.js')
                        .then((registration) => {
                            console.log('SW registered: ', registration);
                        })
                        .catch((registrationError) => {
                            console.log('SW registration failed: ', registrationError);
                        });
                });
            }

            // --- GLOBAL VARIABLES ---
            let jsPDF, PDFLib, PDFDocument, rgb;
            
            // Performance optimization: Initialize variables after libraries load
            const initializeLibraries = () => {
                if (window.jspdf) {
                    jsPDF = window.jspdf.jsPDF;
                }
                if (window.PDFLib) {
                    PDFLib = window.PDFLib;
                    PDFDocument = PDFLib.PDFDocument;
                    rgb = PDFLib.rgb;
                }
            };
            
            // Initialize after core libraries are loaded
            setTimeout(initializeLibraries, 100);

            // --- DOM ELEMENTS ---
            const homeScreen = document.getElementById('home-screen');
            const conversionScreen = document.getElementById('conversion-screen');
            const toolGrid = document.getElementById('tool-grid');
            const backButton = document.getElementById('back-button');
            const fileInput = document.getElementById('file-upload');
            const fileUploadContainer = document.getElementById('file-upload-container');
            const fileUploadText = document.getElementById('file-upload-text');
            const fileNameDisplay = document.getElementById('file-name-display');
            const convertButton = document.getElementById('convert-button');
            const statusArea = document.getElementById('status-area');
            const conversionHeader = document.getElementById('conversion-header');
            const outputFormatContainer = document.getElementById('output-format-container');
            const outputFormatSelect = document.getElementById('output-format-select');
            const pageRangeContainer = document.getElementById('page-range-container');
            const pageRangesInput = document.getElementById('page-ranges');
            const exportFormatContainer = document.getElementById('export-format-container');
            const exportFormatSelect = document.getElementById('export-format-select');
            
            let currentFiles = [];
            let currentTool = null;

            // --- ICONS ---
            const icons = {
                merge: `<svg xmlns="http://www.w3.org/2000/svg" width="32" height="32" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="w-6 h-6 md:w-8 md:h-8 text-indigo-600 dark:text-indigo-400"><path d="M8 6v6h8V6"></path><path d="M4 12v6h16v-6"></path><path d="M12 18v3"></path></svg>`,
                convert: `<svg xmlns="http://www.w3.org/2000/svg" width="32" height="32" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="w-6 h-6 md:w-8 md:h-8 text-indigo-600 dark:text-indigo-400"><path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z"></path><polyline points="14 2 14 8 20 8"></polyline><line x1="16" y1="13" x2="8" y2="13"></line><line x1="16" y1="17" x2="8" y2="17"></line><polyline points="10 9 9 9 8 9"></polyline></svg>`,
                split: `<svg xmlns="http://www.w3.org/2000/svg" width="32" height="32" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="w-6 h-6 md:w-8 md:h-8 text-indigo-600 dark:text-indigo-400"><path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z"></path><polyline points="14 2 14 8 20 8"></polyline><line x1="9" y1="13" x2="15" y2="13"></line><line x1="12" y1="10" x2="12" y2="16"></line></svg>`,
                export: `<svg xmlns="http://www.w3.org/2000/svg" width="32" height="32" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="w-6 h-6 md:w-8 md:h-8 text-indigo-600 dark:text-indigo-400"><path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"></path><polyline points="7 10 12 15 17 10"></polyline><line x1="12" y1="15" x2="12" y2="3"></line></svg>`,
                image: `<svg xmlns="http://www.w3.org/2000/svg" width="32" height="32" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="w-6 h-6 md:w-8 md:h-8 text-indigo-600 dark:text-indigo-400"><rect x="3" y="3" width="18" height="18" rx="2" ry="2"></rect><circle cx="8.5" cy="8.5" r="1.5"></circle><polyline points="21 15 16 10 5 21"></polyline></svg>`,
                doc: `<svg xmlns="http://www.w3.org/2000/svg" width="32" height="32" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="w-6 h-6 md:w-8 md:h-8 text-indigo-600 dark:text-indigo-400"><path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z"></path><polyline points="14 2 14 8 20 8"></polyline><line x1="16" y1="13" x2="8" y2="13"></line><line x1="16" y1="17" x2="8" y2="17"></line><polyline points="10 9 9 9 8 9"></polyline></svg>`,
                sheet: `<svg xmlns="http://www.w3.org/2000/svg" width="32" height="32" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="w-6 h-6 md:w-8 md:h-8 text-indigo-600 dark:text-indigo-400"><path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z"></path><polyline points="14 2 14 8 20 8"></polyline><line x1="16" y1="13" x2="8" y2="13"></line><line x1="16" y1="17" x2="8" y2="17"></line><line x1="10" y1="9" x2="8" y2="17"></line></svg>`,
                compress: `<svg xmlns="http://www.w3.org/2000/svg" width="32" height="32" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="w-6 h-6 md:w-8 md:h-8 text-indigo-600 dark:text-indigo-400"><path d="M4 12V8a2 2 0 0 1 2-2h12a2 2 0 0 1 2 2v4"></path><polyline points="16 16 12 12 8 16"></polyline><line x1="12" y1="12" x2="12" y2="20"></line></svg>`,
                resize: `<svg xmlns="http://www.w3.org/2000/svg" width="32" height="32" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="w-6 h-6 md:w-8 md:h-8 text-indigo-600 dark:text-indigo-400"><path d="M15 3h6v6"></path><path d="M10 14L21 3"></path><path d="M9 21H3v-6"></path><path d="M14 10L3 21"></path></svg>`,
                rotate: `<svg xmlns="http://www.w3.org/2000/svg" width="32" height="32" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="w-6 h-6 md:w-8 md:h-8 text-indigo-600 dark:text-indigo-400"><path d="M21 2v6h-6"></path><path d="M3 12a9 9 0 0 1 15-6.7L21 8"></path><path d="M3 22v-6h6"></path><path d="M21 12a9 9 0 0 1-15 6.7L3 16"></path></svg>`,
                qr: `<svg xmlns="http://www.w3.org/2000/svg" width="32" height="32" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="w-6 h-6 md:w-8 md:h-8 text-indigo-600 dark:text-indigo-400"><rect x="3" y="3" width="5" height="5"></rect><rect x="16" y="3" width="5" height="5"></rect><rect x="3" y="16" width="5" height="5"></rect><path d="M21 16h-3a2 2 0 0 0-2 2v3"></path><path d="M21 21v.01"></path><path d="M12 7v3a2 2 0 0 1-2 2H7"></path><path d="M3 12h.01"></path><path d="M12 3h.01"></path><path d="M12 16v.01"></path><path d="M16 12h1"></path><path d="M21 12v.01"></path><path d="M12 21v-1"></path></svg>`,
                presentation: `<svg xmlns="http://www.w3.org/2000/svg" width="32" height="32" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="w-6 h-6 md:w-8 md:h-8 text-indigo-600 dark:text-indigo-400"><rect x="2" y="3" width="20" height="14" rx="2" ry="2"></rect><line x1="8" y1="21" x2="16" y2="21"></line><line x1="12" y1="17" x2="12" y2="21"></line></svg>`,
                text: `<svg xmlns="http://www.w3.org/2000/svg" width="32" height="32" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="w-6 h-6 md:w-8 md:h-8 text-indigo-600 dark:text-indigo-400"><path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z"></path><polyline points="14 2 14 8 20 8"></polyline><line x1="16" y1="13" x2="8" y2="13"></line><line x1="16" y1="17" x2="8" y2="17"></line><polyline points="10 9 9 9 8 9"></polyline></svg>`,
            };

            // --- TOOL DEFINITIONS ---
            const tools = [
                { 
                    id: 'merge', 
                    icon: icons.merge, 
                    title: 'Merge PDFs', 
                    description: 'Combine multiple PDF files into a single document.',
                    accept: '.pdf',
                    multiple: true
                },
                { 
                    id: 'convert', 
                    icon: icons.convert, 
                    title: 'Convert to PDF', 
                    description: 'Convert various file formats to PDF documents.',
                    accept: '.docx,.xlsx,.pptx,.txt,.md,.jpg,.jpeg,.png,.bmp,.tiff,.gif,.webp',
                    multiple: false
                },
                { 
                    id: 'split', 
                    icon: icons.split, 
                    title: 'Split PDF', 
                    description: 'Extract specific pages from PDF documents.',
                    accept: '.pdf',
                    multiple: false
                },
                { 
                    id: 'export', 
                    icon: icons.export, 
                    title: 'Export PDF', 
                    description: 'Convert PDF files to Word, Excel, PowerPoint, or images.',
                    accept: '.pdf',
                    multiple: false
                },
                { 
                    id: 'compress', 
                    icon: icons.compress, 
                    title: 'PDF Compress', 
                    description: 'Reduce PDF file size while maintaining quality.',
                    accept: '.pdf',
                    multiple: false
                },
                { 
                    id: 'imageConverter', 
                    icon: icons.image, 
                    title: 'Image Converter', 
                    description: 'Convert images between popular formats (PNG, JPG, JPEG, WEBP, GIF).',
                    accept: 'image/png,image/jpeg,image/webp,image/gif,image/bmp,image/heic,image/heif',
                    multiple: false,
                    outputs: ['PNG', 'JPG', 'JPEG', 'WEBP', 'GIF']
                },
                { 
                    id: 'imageResize', 
                    icon: icons.resize, 
                    title: 'Image Resize', 
                    description: 'Resize images to specific dimensions or scale.',
                    accept: 'image/png,image/jpeg,image/webp,image/gif,image/bmp',
                    multiple: false
                },
                { 
                    id: 'imageRotate', 
                    icon: icons.rotate, 
                    title: 'Image Rotate', 
                    description: 'Rotate images by 90°, 180°, or 270°.',
                    accept: 'image/png,image/jpeg,image/webp,image/gif,image/bmp',
                    multiple: false,
                    outputs: ['90°', '180°', '270°']
                },
                { 
                    id: 'img2pdf', 
                    icon: icons.image, 
                    title: 'Image to PDF', 
                    description: 'Convert JPG, PNG, or WEBP files into a PDF document.',
                    accept: 'image/jpeg,image/png,image/webp',
                    multiple: true
                },
                { 
                    id: 'doc2pdf', 
                    icon: icons.doc, 
                    title: 'DOCX to PDF', 
                    description: 'Turn your Word documents into easily shareable PDFs.',
                    accept: '.docx,application/vnd.openxmlformats-officedocument.wordprocessingml.document',
                    multiple: false
                },
                { 
                    id: 'sheet2pdf', 
                    icon: icons.sheet, 
                    title: 'Excel to PDF', 
                    description: 'Convert Excel spreadsheets into PDF files.',
                    accept: '.xlsx,application/vnd.openxmlformats-officedocument.spreadsheetml.sheet',
                    multiple: false
                },
                { 
                    id: 'ppt2pdf', 
                    icon: icons.presentation, 
                    title: 'PowerPoint to PDF', 
                    description: 'Convert PowerPoint presentations to PDF format.',
                    accept: '.pptx,application/vnd.openxmlformats-officedocument.presentationml.presentation',
                    multiple: false
                },
                { 
                    id: 'qrGenerator', 
                    icon: icons.qr, 
                    title: 'QR Code Tool', 
                    description: 'Generate QR codes from text/URLs or scan QR codes to read their content.',
                    accept: 'image/png,image/jpeg,image/webp,image/gif',
                    multiple: false
                },
                { 
                    id: 'textToPdf', 
                    icon: icons.text, 
                    title: 'Text to PDF', 
                    description: 'Convert plain text files to PDF documents.',
                    accept: '.txt,.md,text/plain',
                    multiple: false
                },
            ];

            // --- UI RENDERING WITH PERFORMANCE OPTIMIZATIONS ---
            function renderTools() {
                const fragment = document.createDocumentFragment(); // Performance: Use document fragment
                
                tools.forEach((tool, index) => {
                    const card = document.createElement('div');
                    card.className = `bg-white dark:bg-gray-800/50 p-4 md:p-6 rounded-2xl shadow-lg border border-gray-200 dark:border-gray-700 transform hover:-translate-y-1 transition-all duration-300 ease-in-out cursor-pointer hover:shadow-xl hover:border-indigo-400 dark:hover:border-indigo-500`;
                    
                    // Performance: Lazy load tool cards
                    const observer = new IntersectionObserver((entries) => {
                        entries.forEach(entry => {
                            if (entry.isIntersecting) {
                                entry.target.innerHTML = `
                                    <div class="flex items-center justify-center w-12 h-12 md:w-16 md:h-16 mb-3 md:mb-4 bg-indigo-100 dark:bg-indigo-900/50 rounded-full">
                                        ${tool.icon}
                                    </div>
                                    <h3 class="text-lg md:text-xl font-bold text-gray-800 dark:text-white mb-1 md:mb-2">${tool.title}</h3>
                                    <p class="text-sm md:text-base text-gray-500 dark:text-gray-400">${tool.description}</p>
                                `;
                                entry.target.addEventListener('click', () => showConversionScreen(tool));
                                observer.unobserve(entry.target);
                            }
                        });
                    }, { threshold: 0.1 });
                    
                    // Initially empty card with loading placeholder
                    card.innerHTML = `
                        <div class="flex items-center justify-center w-12 h-12 md:w-16 md:h-16 mb-3 md:mb-4 bg-gray-200 dark:bg-gray-700 rounded-full animate-pulse">
                        </div>
                        <div class="h-6 bg-gray-200 dark:bg-gray-700 rounded animate-pulse mb-2"></div>
                        <div class="h-4 bg-gray-200 dark:bg-gray-700 rounded animate-pulse"></div>
                    `;
                    
                    observer.observe(card);
                    fragment.appendChild(card);
                });
                
                toolGrid.innerHTML = '';
                toolGrid.appendChild(fragment);
            }

            function showConversionScreen(tool) {
                currentTool = tool;
                resetConversionState();
                fileInput.accept = tool.accept;
                fileInput.multiple = tool.multiple;
                
                conversionHeader.innerHTML = `
                    <div class="flex items-center justify-center w-16 h-16 bg-indigo-100 dark:bg-indigo-900/50 rounded-full">
                        ${tool.icon}
                    </div>
                    <div>
                        <h2 class="text-3xl font-bold text-gray-800 dark:text-white">${tool.title}</h2>
                        <p class="text-gray-500 dark:text-gray-400">${tool.description}</p>
                    </div>
                `;

                // Show/hide specific controls based on tool
                outputFormatContainer.classList.add('hidden');
                pageRangeContainer.classList.add('hidden');
                exportFormatContainer.classList.add('hidden');
                document.getElementById('resize-controls').classList.add('hidden');
                document.getElementById('qr-text-container').classList.add('hidden');

                if (tool.id === 'split') {
                    pageRangeContainer.classList.remove('hidden');
                } else if (tool.id === 'export') {
                    exportFormatContainer.classList.remove('hidden');
                } else if (tool.id === 'imageConverter' && tool.outputs) {
                    outputFormatSelect.innerHTML = '';
                    tool.outputs.forEach(format => {
                        const option = document.createElement('option');
                        option.value = format.toLowerCase();
                        option.textContent = format;
                        outputFormatSelect.appendChild(option);
                    });
                    outputFormatContainer.classList.remove('hidden');
                } else if (tool.id === 'imageResize') {
                    document.getElementById('resize-controls').classList.remove('hidden');
                } else if (tool.id === 'imageRotate' && tool.outputs) {
                    outputFormatSelect.innerHTML = '';
                    tool.outputs.forEach(angle => {
                        const option = document.createElement('option');
                        option.value = angle.replace('°', '');
                        option.textContent = `Rotate ${angle}`;
                        outputFormatSelect.appendChild(option);
                    });
                    outputFormatContainer.classList.remove('hidden');
                } else if (tool.id === 'qrGenerator') {
                    document.getElementById('qr-text-container').classList.remove('hidden');
                    // Hide file upload container for generate mode (default tab)
                    fileUploadContainer.style.display = 'none';
                    // Show convert button immediately for QR generator
                    convertButton.classList.remove('hidden');
                    convertButton.disabled = false;
                    convertButton.innerHTML = `<svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><polyline points="13 17 18 12 13 7"></polyline><polyline points="6 17 11 12 6 7"></polyline></svg><span>Generate QR Code</span>`;
                } else {
                    fileUploadContainer.style.display = 'block';
                }

                homeScreen.classList.add('hidden');
                conversionScreen.classList.remove('hidden');
            }

            function showHomeScreen() {
                homeScreen.classList.remove('hidden');
                conversionScreen.classList.add('hidden');
                currentTool = null;
            }
            
            function resetConversionState() {
                currentFiles = [];
                fileInput.value = '';
                fileUploadText.textContent = 'Upload a file';
                fileNameDisplay.textContent = 'Drag and drop or click to upload';
                convertButton.classList.add('hidden');
                statusArea.innerHTML = '';
                pageRangesInput.value = '';
                document.getElementById('qr-text').value = '';
                document.getElementById('resize-width').value = '';
                document.getElementById('resize-height').value = '';
                document.getElementById('qr-scan-result').classList.add('hidden');
                fileUploadContainer.style.display = 'block';
            }

            // --- EVENT LISTENERS ---
            backButton.addEventListener('click', showHomeScreen);

            fileInput.addEventListener('change', (e) => {
                const files = Array.from(e.target.files);
                if (files.length > 0 || currentTool?.id === 'qrGenerator') {
                    currentFiles = files;
                    if (files.length > 0) {
                        fileUploadText.textContent = 'Change file';
                        if (files.length === 1) {
                            fileNameDisplay.textContent = `Selected: ${files[0].name}`;
                        } else {
                            fileNameDisplay.textContent = `Selected: ${files.length} files`;
                        }
                    }
                    convertButton.classList.remove('hidden');
                    convertButton.disabled = false;
                    convertButton.innerHTML = `<svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><polyline points="13 17 18 12 13 7"></polyline><polyline points="6 17 11 12 6 7"></polyline></svg><span>Convert Files</span>`;
                    statusArea.innerHTML = '';
                }
            });

            // Add event listener for QR text input
            document.getElementById('qr-text').addEventListener('input', (e) => {
                if (currentTool?.id === 'qrGenerator') {
                    if (e.target.value.trim()) {
                        convertButton.classList.remove('hidden');
                        convertButton.disabled = false;
                        convertButton.innerHTML = `<svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><polyline points="13 17 18 12 13 7"></polyline><polyline points="6 17 11 12 6 7"></polyline></svg><span>Generate QR Code</span>`;
                        statusArea.innerHTML = '';
                    } else {
                        convertButton.disabled = true;
                    }
                }
            });

            // Add event listeners for QR tabs
            document.getElementById('qr-generate-tab').addEventListener('click', () => {
                // Switch to generate mode
                document.getElementById('qr-generate-tab').className = 'flex-1 py-2 px-4 bg-indigo-600 text-white rounded-lg font-medium';
                document.getElementById('qr-scan-tab').className = 'flex-1 py-2 px-4 bg-gray-200 dark:bg-gray-700 text-gray-700 dark:text-gray-300 rounded-lg font-medium';
                document.getElementById('qr-generate-section').classList.remove('hidden');
                document.getElementById('qr-scan-section').classList.add('hidden');
                // Hide the entire file upload container for generate mode
                fileUploadContainer.style.display = 'none';
                
                // Update button text and state
                const qrText = document.getElementById('qr-text').value.trim();
                if (qrText) {
                    convertButton.disabled = false;
                    convertButton.innerHTML = `<svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><polyline points="13 17 18 12 13 7"></polyline><polyline points="6 17 11 12 6 7"></polyline></svg><span>Generate QR Code</span>`;
                } else {
                    convertButton.disabled = true;
                }
                statusArea.innerHTML = '';
            });

            document.getElementById('qr-scan-tab').addEventListener('click', () => {
                // Switch to scan mode
                document.getElementById('qr-scan-tab').className = 'flex-1 py-2 px-4 bg-indigo-600 text-white rounded-lg font-medium';
                document.getElementById('qr-generate-tab').className = 'flex-1 py-2 px-4 bg-gray-200 dark:bg-gray-700 text-gray-700 dark:text-gray-300 rounded-lg font-medium';
                document.getElementById('qr-generate-section').classList.add('hidden');
                document.getElementById('qr-scan-section').classList.remove('hidden');
                // Show the file upload container for scan mode
                fileUploadContainer.style.display = 'block';
                
                // Update button text and state
                convertButton.disabled = currentFiles.length === 0;
                convertButton.innerHTML = `<svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><polyline points="13 17 18 12 13 7"></polyline><polyline points="6 17 11 12 6 7"></polyline></svg><span>Scan QR Code</span>`;
                statusArea.innerHTML = '';
            });
            
            convertButton.addEventListener('click', handleConvert);

            // --- UTILITY FUNCTIONS ---
            function getOutputFilename(inputName, newExtension) {
                const nameWithoutExtension = inputName.split('.').slice(0, -1).join('.');
                return `${nameWithoutExtension || 'converted'}.${newExtension}`;
            }

            function setStatus(type, title, message) {
                const colors = {
                    loading: 'blue',
                    error: 'red',
                    success: 'green'
                };
                const color = colors[type];
                statusArea.innerHTML = `
                    <div class="bg-${color}-100 dark:bg-${color}-900/50 border-l-4 border-${color}-500 text-${color}-700 dark:text-${color}-300 p-4 rounded-md" role="alert">
                      <p class="font-bold">${title}</p>
                      <p>${message}</p>
                    </div>
                `;
            }

            function setDownloadLink(url, filename) {
                statusArea.innerHTML = `
                    <div class="bg-green-100 dark:bg-green-900/50 p-6 rounded-lg text-center">
                      <h3 class="text-xl font-bold text-green-800 dark:text-green-200 mb-4">Conversion Successful!</h3>
                      <a href="${url}" download="${filename}" class="inline-flex items-center justify-center gap-3 bg-green-600 text-white font-bold py-3 px-8 rounded-lg shadow-md hover:bg-green-700 transition-all duration-300 text-lg">
                        <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"></path><polyline points="7 10 12 15 17 10"></polyline><line x1="12" y1="15" x2="12" y2="3"></line></svg>
                        <span>Download ${filename}</span>
                      </a>
                    </div>
                `;
            }

            function resetButtonState() {
                convertButton.disabled = false;
                convertButton.innerHTML = `<svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><polyline points="13 17 18 12 13 7"></polyline><polyline points="6 17 11 12 6 7"></polyline></svg><span>Convert Files</span>`;
            }

            // --- OPTIMIZED CONVERSION HANDLERS ---
            async function handleConvert() {
                if (!currentTool) return;
                
                // QR Generator doesn't need files, check for text input instead
                if (currentTool.id === 'qrGenerator') {
                    const isGenerateMode = !document.getElementById('qr-generate-section').classList.contains('hidden');
                    if (isGenerateMode) {
                        const qrText = document.getElementById('qr-text').value.trim();
                        if (!qrText) {
                            setStatus('error', 'No text provided', 'Please enter text or URL to generate QR code.');
                            return;
                        }
                    } else {
                        // Scan mode - check for file
                        if (currentFiles.length === 0) {
                            setStatus('error', 'No image provided', 'Please upload an image containing a QR code.');
                            return;
                        }
                    }
                } else if (currentFiles.length === 0) {
                    return;
                }

                // Performance: Show loading state immediately
                convertButton.disabled = true;
                convertButton.innerHTML = `<svg class="animate-spin" xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><line x1="12" y1="2" x2="12" y2="6"></line><line x1="12" y1="18" x2="12" y2="22"></line><line x1="4.93" y1="4.93" x2="7.76" y2="7.76"></line><line x1="16.24" y1="16.24" x2="19.07" y2="19.07"></line><line x1="2" y1="12" x2="6" y2="12"></line><line x1="18" y1="12" x2="22" y2="12"></line><line x1="4.93" y1="19.07" x2="7.76" y2="16.24"></line><line x1="16.24" y1="7.76" x2="19.07" y2="4.93"></line></svg><span>Converting...</span>`;
                
                setStatus('loading', 'Converting files...', 'Please wait while we process your request.');

                try {
                    // Performance: Use requestAnimationFrame for smooth UI updates
                    await new Promise(resolve => requestAnimationFrame(resolve));
                    
                    switch (currentTool.id) {
                        case 'convert':
                            await handleGeneralConvert();
                            break;
                        case 'export':
                            await handlePDFExport();
                            break;
                        case 'compress':
                            await handlePDFCompress();
                            break;
                        case 'imageConverter':
                            await handleImageConversion();
                            break;
                        case 'imageResize':
                            await handleImageResize();
                            break;
                        case 'imageRotate':
                            await handleImageRotate();
                            break;
                        case 'img2pdf':
                            await handleImageToPDF();
                            break;
                        case 'doc2pdf':
                            await handleDocToPDF();
                            break;
                        case 'sheet2pdf':
                            await handleSheetToPDF();
                            break;
                        case 'ppt2pdf':
                            await handlePPTToPDF();
                            break;
                        case 'textToPdf':
                            await handleTextToPDF();
                            break;
                        case 'qrGenerator':
                            await handleQRGenerator();
                            break;
                        case 'merge':
                            await handlePDFMerge();
                            break;
                        case 'split':
                            await handlePDFSplit();
                            break;
                    }
                } catch (error) {
                    console.error('Conversion error:', error);
                    setStatus('error', 'Conversion failed', 'An error occurred while processing your files. Please try again.');
                    resetButtonState();
                }
            }

            // --- OPTIMIZED IMAGE CONVERSION ---
            async function handleImageConversion() {
                // Load HEIC library only if needed
                if (currentFiles[0].type.startsWith('image/heic') || currentFiles[0].type.startsWith('image/heif')) {
                    if (!window.heic2any) {
                        setStatus('loading', 'Loading HEIC converter...', 'Please wait...');
                        await loadLibrary('heic2any', optionalLibraries.heic2any);
                    }
                }
                
                const outputFormat = outputFormatSelect.value.toLowerCase();
                const formatMap = {
                    'png': { mime: 'image/png', ext: 'png' },
                    'jpg': { mime: 'image/jpeg', ext: 'jpg' },
                    'jpeg': { mime: 'image/jpeg', ext: 'jpeg' },
                    'webp': { mime: 'image/webp', ext: 'webp' },
                    'gif': { mime: 'image/gif', ext: 'gif' }
                };

                const format = formatMap[outputFormat];
                if (!format) {
                    setStatus('error', 'Unsupported Format', `The format ${outputFormat.toUpperCase()} is not supported.`);
                    resetButtonState();
                    return;
                }

                let blobToProcess = currentFiles[0];
                if (currentFiles[0].type.startsWith('image/heic') || currentFiles[0].type.startsWith('image/heif')) {
                    setStatus('loading', 'Processing HEIC...', 'Converting HEIC/HEIF format...');
                    blobToProcess = await heic2any({ blob: currentFiles[0], toType: "image/png" });
                }

                // Performance: Use createImageBitmap for better memory management
                try {
                    const imageBitmap = await createImageBitmap(blobToProcess);
                    
                    const canvas = document.createElement('canvas');
                    canvas.width = imageBitmap.width;
                    canvas.height = imageBitmap.height;
                    const ctx = canvas.getContext('2d');
                    
                    // Handle JPG/JPEG format that needs white background
                    if (outputFormat === 'jpg' || outputFormat === 'jpeg') {
                        ctx.fillStyle = '#FFFFFF';
                        ctx.fillRect(0, 0, canvas.width, canvas.height);
                    }
                    
                    ctx.drawImage(imageBitmap, 0, 0);
                    
                    // Performance: Clean up ImageBitmap to free memory
                    imageBitmap.close();
                    
                    // Set quality for JPEG formats
                    const quality = (outputFormat === 'jpg' || outputFormat === 'jpeg') ? 0.9 : undefined;
                    
                    // Performance: Use toBlob for large images to avoid memory issues
                    canvas.toBlob((blob) => {
                        const url = URL.createObjectURL(blob);
                        setDownloadLink(url, getOutputFilename(currentFiles[0].name, format.ext));
                        resetButtonState();
                        
                        // Clean up canvas
                        canvas.width = canvas.height = 0;
                    }, format.mime, quality);
                    
                } catch (error) {
                    console.error('Image processing error:', error);
                    setStatus('error', 'Image Load Error', 'Could not process the selected image. It may be corrupt.');
                    resetButtonState();
                }
            }

            // --- IMAGE TO PDF ---
            async function handleImageToPDF() {
                if (currentFiles.length === 1) {
                    // Single image
                    const reader = new FileReader();
                    reader.onload = (e) => {
                        const img = new Image();
                        img.onload = () => {
                            const pdf = new jsPDF({ 
                                orientation: img.width > img.height ? 'l' : 'p', 
                                unit: 'px', 
                                format: [img.width, img.height] 
                            });
                            pdf.addImage(img, 'PNG', 0, 0, img.width, img.height);
                            setDownloadLink(pdf.output('bloburl'), getOutputFilename(currentFiles[0].name, 'pdf'));
                            resetButtonState();
                        };
                        img.src = e.target.result;
                    };
                    reader.readAsDataURL(currentFiles[0]);
                } else {
                    // Multiple images
                    const pdf = new jsPDF();
                    let imagesProcessed = 0;
                    const totalImages = currentFiles.length;

                    currentFiles.forEach((file, index) => {
                        const reader = new FileReader();
                        reader.onload = (e) => {
                            const img = new Image();
                            img.onload = () => {
                                if (index > 0) pdf.addPage();
                                
                                const pageWidth = pdf.internal.pageSize.getWidth();
                                const pageHeight = pdf.internal.pageSize.getHeight();
                                const imgAspectRatio = img.width / img.height;
                                const pageAspectRatio = pageWidth / pageHeight;
                                
                                let imgWidth, imgHeight, x, y;
                                if (imgAspectRatio > pageAspectRatio) {
                                    imgWidth = pageWidth;
                                    imgHeight = pageWidth / imgAspectRatio;
                                    x = 0;
                                    y = (pageHeight - imgHeight) / 2;
                                } else {
                                    imgHeight = pageHeight;
                                    imgWidth = pageHeight * imgAspectRatio;
                                    x = (pageWidth - imgWidth) / 2;
                                    y = 0;
                                }
                                
                                pdf.addImage(img, 'PNG', x, y, imgWidth, imgHeight);
                                imagesProcessed++;
                                
                                if (imagesProcessed === totalImages) {
                                    setDownloadLink(pdf.output('bloburl'), 'images.pdf');
                                    resetButtonState();
                                }
                            };
                            img.src = e.target.result;
                        };
                        reader.readAsDataURL(file);
                    });
                }
            }

            // --- OPTIMIZED DOCX TO PDF ---
            async function handleDocToPDF() {
                // Load mammoth and html2canvas only when needed
                if (!window.mammoth) {
                    setStatus('loading', 'Loading document converter...', 'Please wait...');
                    await loadLibrary('mammoth', optionalLibraries.mammoth);
                }
                if (!window.html2canvas) {
                    setStatus('loading', 'Loading rendering engine...', 'Please wait...');
                    await loadLibrary('html2canvas', optionalLibraries.html2canvas);
                }
                
                const reader = new FileReader();
                reader.onload = async (e) => {
                    try {
                        const arrayBuffer = e.target.result;
                        setStatus('loading', 'Converting document...', 'Processing DOCX content...');
                        
                        const result = await mammoth.convertToHtml({ arrayBuffer });
                        const htmlContent = `<div style="padding: 40px; font-family: Arial, sans-serif; line-height: 1.6;">${result.value}</div>`;
                        
                        setStatus('loading', 'Rendering PDF...', 'Creating PDF document...');
                        
                        const renderContainer = document.createElement('div');
                        renderContainer.innerHTML = htmlContent;
                        renderContainer.style.position = 'absolute';
                        renderContainer.style.left = '-9999px';
                        renderContainer.style.width = '800px';
                        renderContainer.style.background = 'white';
                        document.body.appendChild(renderContainer);

                        // Performance: Use lower scale for better memory usage
                        const canvas = await html2canvas(renderContainer, { 
                            scale: 1.5,
                            useCORS: true,
                            allowTaint: false
                        });
                        document.body.removeChild(renderContainer);

                        const imgData = canvas.toDataURL('image/png', 0.8); // Reduced quality for better performance
                        const pdf = new jsPDF({ 
                            orientation: canvas.width > canvas.height ? 'l' : 'p', 
                            unit: 'px', 
                            format: [canvas.width, canvas.height] 
                        });
                        pdf.addImage(imgData, 'PNG', 0, 0, canvas.width, canvas.height);
                        
                        setDownloadLink(pdf.output('bloburl'), getOutputFilename(currentFiles[0].name, 'pdf'));
                        resetButtonState();
                        
                        // Clean up canvas
                        canvas.width = canvas.height = 0;
                    } catch (err) {
                        console.error("Conversion error:", err);
                        setStatus('error', 'Failed to convert DOCX', 'The file might be complex, corrupted, or password-protected.');
                        resetButtonState();
                    }
                };
                reader.readAsArrayBuffer(currentFiles[0]);
            }

            // --- EXCEL TO PDF ---
            async function handleSheetToPDF() {
                const reader = new FileReader();
                reader.onload = async (e) => {
                    try {
                        const arrayBuffer = e.target.result;
                        const workbook = XLSX.read(arrayBuffer, { type: 'buffer' });
                        const sheetName = workbook.SheetNames[0];
                        const worksheet = workbook.Sheets[sheetName];
                        const htmlContent = `<div style="padding: 20px; font-family: Arial, sans-serif;">${XLSX.utils.sheet_to_html(worksheet)}</div>`;
                        
                        const renderContainer = document.createElement('div');
                        renderContainer.innerHTML = htmlContent;
                        renderContainer.style.position = 'absolute';
                        renderContainer.style.left = '-9999px';
                        renderContainer.style.width = '1000px';
                        renderContainer.style.background = 'white';
                        document.body.appendChild(renderContainer);

                        const canvas = await html2canvas(renderContainer, { scale: 2 });
                        document.body.removeChild(renderContainer);

                        const imgData = canvas.toDataURL('image/png');
                        const pdf = new jsPDF({ 
                            orientation: canvas.width > canvas.height ? 'l' : 'p', 
                            unit: 'px', 
                            format: [canvas.width, canvas.height] 
                        });
                        pdf.addImage(imgData, 'PNG', 0, 0, canvas.width, canvas.height);
                        setDownloadLink(pdf.output('bloburl'), getOutputFilename(currentFiles[0].name, 'pdf'));
                        resetButtonState();
                    } catch (err) {
                        console.error("Conversion error:", err);
                        setStatus('error', 'Failed to convert Excel', 'The file might be complex, corrupted, or password-protected.');
                        resetButtonState();
                    }
                };
                reader.readAsArrayBuffer(currentFiles[0]);
            }

            // --- PDF MERGE ---
            async function handlePDFMerge() {
                try {
                    const mergedPdf = await PDFDocument.create();
                    
                    for (const file of currentFiles) {
                        const arrayBuffer = await file.arrayBuffer();
                        const pdf = await PDFDocument.load(arrayBuffer);
                        const copiedPages = await mergedPdf.copyPages(pdf, pdf.getPageIndices());
                        copiedPages.forEach((page) => mergedPdf.addPage(page));
                    }
                    
                    const pdfBytes = await mergedPdf.save();
                    const blob = new Blob([pdfBytes], { type: 'application/pdf' });
                    const url = URL.createObjectURL(blob);
                    
                    setDownloadLink(url, 'merged.pdf');
                    resetButtonState();
                } catch (err) {
                    console.error("PDF merge error:", err);
                    setStatus('error', 'Failed to merge PDFs', 'One or more PDF files might be corrupted or password-protected.');
                    resetButtonState();
                }
            }

            // --- PDF SPLIT ---
            async function handlePDFSplit() {
                try {
                    const pageRanges = pageRangesInput.value;
                    if (!pageRanges) {
                        setStatus('error', 'Page ranges required', 'Please specify which pages to extract (e.g., 1-3,5,7-10).');
                        resetButtonState();
                        return;
                    }

                    // Parse page ranges
                    const pageList = [];
                    const ranges = pageRanges.replace(/\s/g, '').split(',');
                    for (const range of ranges) {
                        if (range.includes('-')) {
                            const [start, end] = range.split('-').map(Number);
                            for (let i = start; i <= end; i++) {
                                pageList.push(i - 1); // Convert to 0-based indexing
                            }
                        } else {
                            pageList.push(Number(range) - 1); // Convert to 0-based indexing
                        }
                    }

                    const arrayBuffer = await currentFiles[0].arrayBuffer();
                    const pdf = await PDFDocument.load(arrayBuffer);
                    const newPdf = await PDFDocument.create();
                    
                    const pages = await newPdf.copyPages(pdf, pageList);
                    pages.forEach((page) => newPdf.addPage(page));
                    
                    const pdfBytes = await newPdf.save();
                    const blob = new Blob([pdfBytes], { type: 'application/pdf' });
                    const url = URL.createObjectURL(blob);
                    
                    setDownloadLink(url, getOutputFilename(currentFiles[0].name, 'pdf'));
                    resetButtonState();
                } catch (err) {
                    console.error("PDF split error:", err);
                    setStatus('error', 'Failed to split PDF', 'The PDF file might be corrupted, password-protected, or the page range is invalid.');
                    resetButtonState();
                }
            }

            // --- GENERAL CONVERT FUNCTION ---
            async function handleGeneralConvert() {
                const file = currentFiles[0];
                const fileType = file.type || file.name.split('.').pop().toLowerCase();
                
                // Determine conversion type based on file extension/type
                if (fileType.includes('image/') || ['jpg', 'jpeg', 'png', 'webp', 'bmp', 'gif', 'tiff'].includes(fileType)) {
                    await handleImageToPDF();
                } else if (fileType.includes('application/vnd.openxmlformats-officedocument.wordprocessingml.document') || fileType === 'docx') {
                    await handleDocToPDF();
                } else if (fileType.includes('application/vnd.openxmlformats-officedocument.spreadsheetml.sheet') || fileType === 'xlsx') {
                    await handleSheetToPDF();
                } else if (fileType === 'txt' || fileType === 'md') {
                    await handleTextToPDF();
                } else {
                    setStatus('error', 'Unsupported file type', 'This file type is not supported for conversion to PDF.');
                    resetButtonState();
                }
            }

            // --- TEXT TO PDF CONVERSION ---
            async function handleTextToPDF() {
                const reader = new FileReader();
                reader.onload = (e) => {
                    try {
                        const text = e.target.result;
                        const pdf = new jsPDF();
                        
                        // Split text into lines and add to PDF
                        const lines = pdf.splitTextToSize(text, 180);
                        let y = 20;
                        
                        lines.forEach(line => {
                            if (y > 280) { // Check if we need a new page
                                pdf.addPage();
                                y = 20;
                            }
                            pdf.text(line, 10, y);
                            y += 7;
                        });
                        
                        setDownloadLink(pdf.output('bloburl'), getOutputFilename(currentFiles[0].name, 'pdf'));
                        resetButtonState();
                    } catch (err) {
                        console.error("Text conversion error:", err);
                        setStatus('error', 'Failed to convert text', 'An error occurred while converting the text file.');
                        resetButtonState();
                    }
                };
                reader.readAsText(currentFiles[0]);
            }

            // --- PDF EXPORT FUNCTION ---
            async function handlePDFExport() {
                const exportFormat = exportFormatSelect.value;
                
                try {
                    const arrayBuffer = await currentFiles[0].arrayBuffer();
                    
                    if (exportFormat === 'images') {
                        // Convert PDF to images using PDF-lib
                        const pdf = await PDFDocument.load(arrayBuffer);
                        const pages = pdf.getPages();
                        
                        if (pages.length === 1) {
                            // Single page - convert to single image
                            await convertPDFPageToImage(pdf, 0);
                        } else {
                            // Multiple pages - create ZIP with all images
                            await convertPDFToImageZip(pdf);
                        }
                    } else {
                        setStatus('error', 'Feature not available', `Export to ${exportFormat} is not yet implemented in the client-side version. This feature requires server-side processing.`);
                        resetButtonState();
                    }
                } catch (err) {
                    console.error("PDF export error:", err);
                    setStatus('error', 'Failed to export PDF', 'An error occurred while exporting the PDF file.');
                    resetButtonState();
                }
            }

            // --- PDF TO IMAGE CONVERSION ---
            async function convertPDFPageToImage(pdf, pageIndex) {
                try {
                    // This is a simplified implementation
                    // For a full implementation, you'd need a library like PDF.js
                    setStatus('error', 'Feature not available', 'PDF to image conversion requires additional libraries. This feature is available in the server version.');
                    resetButtonState();
                } catch (err) {
                    console.error("PDF to image error:", err);
                    setStatus('error', 'Conversion failed', 'Failed to convert PDF to image.');
                    resetButtonState();
                }
            }

            async function convertPDFToImageZip(pdf) {
                try {
                    setStatus('error', 'Feature not available', 'PDF to multiple images with ZIP download requires additional libraries. This feature is available in the server version.');
                    resetButtonState();
                } catch (err) {
                    console.error("PDF to ZIP error:", err);
                    setStatus('error', 'Conversion failed', 'Failed to convert PDF to image ZIP.');
                    resetButtonState();
                }
            }

            // --- PDF COMPRESS ---
            async function handlePDFCompress() {
                try {
                    const arrayBuffer = await currentFiles[0].arrayBuffer();
                    const pdf = await PDFDocument.load(arrayBuffer);
                    
                    // Basic compression by optimizing images and removing duplicate objects
                    const pdfBytes = await pdf.save({
                        useObjectStreams: false,
                        addDefaultPage: false,
                    });
                    
                    const blob = new Blob([pdfBytes], { type: 'application/pdf' });
                    const url = URL.createObjectURL(blob);
                    
                    // Calculate compression ratio
                    const originalSize = currentFiles[0].size;
                    const compressedSize = blob.size;
                    const compressionRatio = ((originalSize - compressedSize) / originalSize * 100).toFixed(1);
                    
                    setStatus('success', 'PDF Compressed', `File size reduced by ${compressionRatio}% (${(originalSize/1024/1024).toFixed(1)}MB → ${(compressedSize/1024/1024).toFixed(1)}MB)`);
                    setDownloadLink(url, getOutputFilename(currentFiles[0].name, 'pdf'));
                    resetButtonState();
                } catch (err) {
                    console.error("PDF compression error:", err);
                    setStatus('error', 'Failed to compress PDF', 'The PDF file might be corrupted or password-protected.');
                    resetButtonState();
                }
            }

            // --- IMAGE RESIZE ---
            async function handleImageResize() {
                const width = parseInt(document.getElementById('resize-width').value);
                const height = parseInt(document.getElementById('resize-height').value);
                const maintainAspectRatio = document.getElementById('maintain-aspect-ratio').checked;

                if (!width || !height) {
                    setStatus('error', 'Invalid dimensions', 'Please enter valid width and height values.');
                    resetButtonState();
                    return;
                }

                const reader = new FileReader();
                reader.onload = (e) => {
                    const img = new Image();
                    img.onload = () => {
                        const canvas = document.createElement('canvas');
                        const ctx = canvas.getContext('2d');
                        
                        let newWidth = width;
                        let newHeight = height;
                        
                        if (maintainAspectRatio) {
                            const aspectRatio = img.width / img.height;
                            if (width / height > aspectRatio) {
                                newWidth = height * aspectRatio;
                            } else {
                                newHeight = width / aspectRatio;
                            }
                        }
                        
                        canvas.width = newWidth;
                        canvas.height = newHeight;
                        ctx.drawImage(img, 0, 0, newWidth, newHeight);
                        
                        const dataUrl = canvas.toDataURL('image/png');
                        setDownloadLink(dataUrl, getOutputFilename(currentFiles[0].name, 'png'));
                        resetButtonState();
                    };
                    img.src = e.target.result;
                };
                reader.readAsDataURL(currentFiles[0]);
            }

            // --- IMAGE ROTATE ---
            async function handleImageRotate() {
                const angle = parseInt(outputFormatSelect.value);
                
                const reader = new FileReader();
                reader.onload = (e) => {
                    const img = new Image();
                    img.onload = () => {
                        const canvas = document.createElement('canvas');
                        const ctx = canvas.getContext('2d');
                        
                        // Set canvas dimensions based on rotation
                        if (angle === 90 || angle === 270) {
                            canvas.width = img.height;
                            canvas.height = img.width;
                        } else {
                            canvas.width = img.width;
                            canvas.height = img.height;
                        }
                        
                        // Translate and rotate
                        ctx.translate(canvas.width / 2, canvas.height / 2);
                        ctx.rotate((angle * Math.PI) / 180);
                        ctx.drawImage(img, -img.width / 2, -img.height / 2);
                        
                        const dataUrl = canvas.toDataURL('image/png');
                        setDownloadLink(dataUrl, getOutputFilename(currentFiles[0].name, 'png'));
                        resetButtonState();
                    };
                    img.src = e.target.result;
                };
                reader.readAsDataURL(currentFiles[0]);
            }

            // --- POWERPOINT TO PDF ---
            async function handlePPTToPDF() {
                // PowerPoint to PDF conversion requires server-side processing
                // This is a placeholder for client-side limitations
                setStatus('error', 'Feature not available', 'PowerPoint to PDF conversion requires server-side processing. This feature is available in the full server version.');
                resetButtonState();
            }

            // --- QR CODE GENERATOR & SCANNER ---
            async function handleQRGenerator() {
                const isGenerateMode = !document.getElementById('qr-generate-section').classList.contains('hidden');
                
                if (isGenerateMode) {
                    // Generate QR Code - optimized for low memory usage
                    const text = document.getElementById('qr-text').value.trim();
                    
                    if (!text) {
                        setStatus('error', 'No text provided', 'Please enter text or URL to generate QR code.');
                        resetButtonState();
                        return;
                    }

                    try {
                        // Check if QRCode library is available
                        if (typeof QRCode === 'undefined') {
                            // Fallback: Use QR Server API (more memory efficient)
                            const qrUrl = `https://api.qrserver.com/v1/create-qr-code/?size=300x300&data=${encodeURIComponent(text)}`;
                            
                            setStatus('success', 'QR Code Generated', `QR code created for: ${text.length > 50 ? text.substring(0, 50) + '...' : text}`);
                            statusArea.innerHTML += `
                                <div class="mt-4 text-center">
                                    <img src="${qrUrl}" alt="QR Code" class="mx-auto mb-4 border border-gray-300 rounded" style="max-width: 250px;" loading="lazy">
                                    <br>
                                    <a href="${qrUrl}" download="qr-code.png" class="inline-flex items-center justify-center gap-3 bg-green-600 text-white font-bold py-3 px-8 rounded-lg shadow-md hover:bg-green-700 transition-all duration-300 text-lg">
                                        <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"></path><polyline points="7 10 12 15 17 10"></polyline><line x1="12" y1="15" x2="12" y2="3"></line></svg>
                                        <span>Download QR Code</span>
                                    </a>
                                </div>
                            `;
                            resetButtonState();
                            return;
                        }

                        // Use smaller canvas size for better performance
                        const canvas = document.createElement('canvas');
                        await QRCode.toCanvas(canvas, text, {
                            width: 300,
                            margin: 1,
                            color: {
                                dark: '#000000',
                                light: '#FFFFFF'
                            }
                        });
                        
                        // Convert to blob for better memory management
                        canvas.toBlob((blob) => {
                            const url = URL.createObjectURL(blob);
                            setDownloadLink(url, 'qr-code.png');
                            // Clean up canvas reference
                            canvas.width = 0;
                            canvas.height = 0;
                        }, 'image/png', 0.8);
                        
                        setStatus('success', 'QR Code Generated', `QR code created for: ${text.length > 50 ? text.substring(0, 50) + '...' : text}`);
                        resetButtonState();
                    } catch (err) {
                        console.error("QR generation error:", err);
                        setStatus('error', 'Failed to generate QR code', `Error details: ${err.message || 'Unknown error occurred'}`);
                        resetButtonState();
                    }
                } else {
                    // Scan QR Code - optimized for memory usage
                    try {
                        const file = currentFiles[0];
                        
                        // Check file size for memory efficiency
                        if (file.size > 5 * 1024 * 1024) { // 5MB limit
                            setStatus('error', 'File too large', 'Please upload an image smaller than 5MB for QR scanning.');
                            resetButtonState();
                            return;
                        }
                        
                        const reader = new FileReader();
                        
                        reader.onload = async (e) => {
                            try {
                                const img = new Image();
                                img.onload = async () => {
                                    try {
                                        // Create optimized canvas
                                        const canvas = document.createElement('canvas');
                                        const ctx = canvas.getContext('2d');
                                        
                                        // Resize large images for better performance
                                        const maxSize = 800;
                                        let { width, height } = img;
                                        
                                        if (width > maxSize || height > maxSize) {
                                            const ratio = Math.min(maxSize / width, maxSize / height);
                                            width *= ratio;
                                            height *= ratio;
                                        }
                                        
                                        canvas.width = width;
                                        canvas.height = height;
                                        ctx.drawImage(img, 0, 0, width, height);
                                        
                                        // Try to scan QR code using QrScanner if available
                                        if (typeof QrScanner !== 'undefined') {
                                            const result = await QrScanner.scanImage(img);
                                            displayQRScanResult(result);
                                        } else {
                                            // Fallback: Use online QR scanner API
                                            const formData = new FormData();
                                            formData.append('file', file);
                                            
                                            const response = await fetch('https://api.qrserver.com/v1/read-qr-code/', {
                                                method: 'POST',
                                                body: formData
                                            });
                                            
                                            const data = await response.json();
                                            if (data && data[0] && data[0].symbol && data[0].symbol[0] && data[0].symbol[0].data) {
                                                displayQRScanResult(data[0].symbol[0].data);
                                            } else {
                                                setStatus('error', 'No QR Code Found', 'Could not detect a QR code in the uploaded image. Please make sure the image contains a clear QR code.');
                                            }
                                        }
                                        
                                        // Clean up resources
                                        canvas.width = 0;
                                        canvas.height = 0;
                                        img.src = '';
                                        resetButtonState();
                                    } catch (scanError) {
                                        console.error("QR scan error:", scanError);
                                        setStatus('error', 'Scan Failed', 'Could not read QR code from the image. Please ensure the image contains a clear, readable QR code.');
                                        resetButtonState();
                                    }
                                };
                                img.onerror = () => {
                                    setStatus('error', 'Image Error', 'Could not load the uploaded image.');
                                    resetButtonState();
                                };
                                img.src = e.target.result;
                            } catch (err) {
                                console.error("Image load error:", err);
                                setStatus('error', 'Image Error', 'Could not load the uploaded image.');
                                resetButtonState();
                            }
                        };
                        
                        reader.onerror = () => {
                            setStatus('error', 'File Read Error', 'Could not read the uploaded file.');
                            resetButtonState();
                        };
                        
                        reader.readAsDataURL(file);
                    } catch (err) {
                        console.error("QR scan error:", err);
                        setStatus('error', 'Failed to scan QR code', `Error details: ${err.message || 'Unknown error occurred'}`);
                        resetButtonState();
                    }
                }
            }

            function displayQRScanResult(qrContent) {
                const resultDiv = document.getElementById('qr-scan-result');
                const contentDiv = document.getElementById('qr-scan-content');
                
                contentDiv.textContent = qrContent;
                resultDiv.classList.remove('hidden');
                
                setStatus('success', 'QR Code Scanned Successfully', 'The QR code content is displayed below.');
                
                // Add copy to clipboard functionality
                contentDiv.innerHTML = `
                    <div class="flex items-center justify-between">
                        <span class="flex-1 break-all">${qrContent}</span>
                        <button onclick="navigator.clipboard.writeText('${qrContent.replace(/'/g, "\\'")}').then(() => alert('Copied to clipboard!'))" 
                                class="ml-2 px-3 py-1 bg-green-600 text-white text-sm rounded hover:bg-green-700">
                            Copy
                        </button>
                    </div>
                `;
            }

            // Memory management utility
            function cleanupMemory() {
                // Clear any temporary URLs
                document.querySelectorAll('a[href^="blob:"]').forEach(link => {
                    URL.revokeObjectURL(link.href);
                });
                
                // Clear status area of large content
                const statusArea = document.getElementById('status-area');
                if (statusArea && statusArea.innerHTML.length > 10000) {
                    statusArea.innerHTML = '<p class="text-gray-600">Status cleared to free memory...</p>';
                }
                
                // Force garbage collection if available
                if (window.gc) {
                    window.gc();
                }
            }

            // Add cleanup on page unload
            window.addEventListener('beforeunload', cleanupMemory);
            
            // Periodic memory cleanup (every 5 minutes)
            setInterval(cleanupMemory, 5 * 60 * 1000);

            // --- INITIALIZATION ---
            renderTools();

            // Add drag and drop support
            ['dragenter', 'dragover', 'dragleave', 'drop'].forEach(eventName => {
                document.addEventListener(eventName, preventDefaults, false);
            });

            function preventDefaults(e) {
                e.preventDefault();
                e.stopPropagation();
            }

            document.addEventListener('drop', handleDrop, false);

            function handleDrop(e) {
                const dt = e.dataTransfer;
                const files = dt.files;
                
                if (conversionScreen.classList.contains('hidden')) return;
                
                fileInput.files = files;
                fileInput.dispatchEvent(new Event('change'));
            }
        });
    </script>
</body>
</html>
